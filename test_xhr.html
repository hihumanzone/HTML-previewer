<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMLHttpRequest Override Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1e1e1e;
            color: #f8f8f2;
        }
        .log {
            background: #282a36;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #6272a4;
        }
        .success { border-left-color: #50fa7b; }
        .error { border-left-color: #ff5555; }
        button {
            background: #6272a4;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #44475a; }
    </style>
</head>
<body>
    <h1>XMLHttpRequest Override Test</h1>
    <p>Testing if the XMLHttpRequest override works for virtual file system:</p>
    
    <button onclick="testFetchImage()">Test Fetch Image</button>
    <button onclick="testXHRImage()">Test XHR Image</button>
    <button onclick="testXHRText()">Test XHR Text</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    
    <script>
        // Simulate virtual file system
        const virtualFileSystem = {
            'assets/test-image.png': {
                content: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                type: 'image',
                isBinary: true
            },
            'assets/test.txt': {
                content: 'Hello, this is a test file!',
                type: 'text',
                isBinary: false
            },
            'assets/config.json': {
                content: '{"message": "This is a JSON config", "version": "1.0"}',
                type: 'json',
                isBinary: false
            }
        };
        
        const mainHtmlPath = 'index.html';
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Copy the actual XMLHttpRequest override from the script
        function setupXHROverride() {
            function resolvePath(basePath, relativePath) {
                if (relativePath.startsWith("/")) {
                    return relativePath.substring(1);
                }
                
                const baseDir = basePath.includes("/") ? basePath.substring(0, basePath.lastIndexOf("/")) : "";
                const baseParts = baseDir ? baseDir.split("/") : [];
                const relativeParts = relativePath.split("/");
                const resultParts = [...baseParts];
                
                for (const part of relativeParts) {
                    if (part === "..") {
                        if (resultParts.length > 0) {
                            resultParts.pop();
                        }
                    } else if (part !== "." && part !== "") {
                        resultParts.push(part);
                    }
                }
                
                return resultParts.join("/");
            }
            
            function findFileInSystem(targetFilename, currentFilePath = "") {
                if (currentFilePath) {
                    targetFilename = resolvePath(currentFilePath, targetFilename);
                }
                
                const exactMatch = virtualFileSystem[targetFilename];
                if (exactMatch) {
                    return exactMatch;
                }
                
                const targetLower = targetFilename.toLowerCase();
                for (const [filename, file] of Object.entries(virtualFileSystem)) {
                    if (filename.toLowerCase() === targetLower) {
                        return file;
                    }
                }
                
                return null;
            }
            
            function getCurrentFilePath() {
                try {
                    if (window.__currentExecutionContext) {
                        return window.__currentExecutionContext;
                    }
                    return mainHtmlPath;
                } catch (e) {
                    return mainHtmlPath;
                }
            }
            
            // Override XMLHttpRequest
            const OriginalXMLHttpRequest = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new OriginalXMLHttpRequest();
                const originalOpen = xhr.open;
                const originalSend = xhr.send;
                
                let isVirtualRequest = false;
                let virtualFileData = null;
                
                xhr.open = function(method, url, async, user, password) {
                    try {
                        if (method.toUpperCase() === "GET") {
                            const currentFilePath = getCurrentFilePath();
                            let targetPath = url.replace(/^\.\//, "");
                            const fileData = findFileInSystem(targetPath, currentFilePath);
                            
                            if (fileData) {
                                // Handle virtual file system request
                                isVirtualRequest = true;
                                virtualFileData = fileData;
                                log(`XHR Override: Intercepted request for ${url} -> virtual file system`, 'success');
                                // Don't call original open for virtual requests
                                return;
                            }
                        }
                        
                        // Handle normal requests
                        isVirtualRequest = false;
                        virtualFileData = null;
                        log(`XHR Override: Passing through request for ${url}`, 'info');
                        return originalOpen.call(this, method, url, async, user, password);
                    } catch (e) {
                        // Fallback to normal request on any error
                        log(`XHR Override: Error in open, falling back to normal request: ${e.message}`, 'error');
                        isVirtualRequest = false;
                        virtualFileData = null;
                        return originalOpen.call(this, method, url, async, user, password);
                    }
                };
                
                xhr.send = function(data) {
                    if (isVirtualRequest && virtualFileData) {
                        try {
                            // Simulate successful response for virtual files
                            setTimeout(() => {
                                try {
                                    // Set response properties
                                    Object.defineProperty(xhr, 'readyState', { value: 4, configurable: true });
                                    Object.defineProperty(xhr, 'status', { value: 200, configurable: true });
                                    Object.defineProperty(xhr, 'statusText', { value: 'OK', configurable: true });
                                    
                                    // Set response content
                                    if (virtualFileData.isBinary && virtualFileData.content.startsWith("data:")) {
                                        // For binary files (images, audio, etc.)
                                        if (xhr.responseType === "arraybuffer") {
                                            // Convert data URL to ArrayBuffer
                                            const [header, base64] = virtualFileData.content.split(",");
                                            const byteCharacters = atob(base64);
                                            const byteNumbers = new Array(byteCharacters.length);
                                            for (let i = 0; i < byteCharacters.length; i++) {
                                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                                            }
                                            Object.defineProperty(xhr, 'response', { value: new Uint8Array(byteNumbers).buffer, configurable: true });
                                            log(`XHR Override: Returning ArrayBuffer for binary file (${byteNumbers.length} bytes)`, 'success');
                                        } else {
                                            // Return data URL for other response types
                                            Object.defineProperty(xhr, 'response', { value: virtualFileData.content, configurable: true });
                                            Object.defineProperty(xhr, 'responseText', { value: virtualFileData.content, configurable: true });
                                            log(`XHR Override: Returning data URL for binary file`, 'success');
                                        }
                                    } else {
                                        // For text files
                                        Object.defineProperty(xhr, 'responseText', { value: virtualFileData.content, configurable: true });
                                        Object.defineProperty(xhr, 'response', { value: virtualFileData.content, configurable: true });
                                        log(`XHR Override: Returning text content (${virtualFileData.content.length} chars)`, 'success');
                                    }
                                    
                                    // Set headers
                                    xhr.getResponseHeader = function(name) {
                                        const lowerName = name.toLowerCase();
                                        if (lowerName === "content-type") {
                                            const typeMap = {
                                                "image": "image/png",
                                                "audio": "audio/mpeg",
                                                "video": "video/mp4",
                                                "json": "application/json",
                                                "css": "text/css",
                                                "javascript": "text/javascript",
                                                "html": "text/html"
                                            };
                                            return typeMap[virtualFileData.type] || "text/plain";
                                        }
                                        return null;
                                    };
                                    
                                    xhr.getAllResponseHeaders = function() {
                                        const contentType = xhr.getResponseHeader("content-type");
                                        return `content-type: ${contentType}\r\n`;
                                    };
                                    
                                    // Trigger events
                                    if (xhr.onreadystatechange) {
                                        xhr.onreadystatechange();
                                    }
                                    if (xhr.onload) {
                                        xhr.onload();
                                    }
                                    log(`XHR Override: Successfully triggered events for virtual file`, 'success');
                                } catch (e) {
                                    // Handle error in response simulation
                                    log(`XHR Override: Error in response simulation: ${e.message}`, 'error');
                                    if (xhr.onerror) {
                                        xhr.onerror();
                                    }
                                }
                            }, 1);
                        } catch (e) {
                            // Handle error in virtual request
                            log(`XHR Override: Error in virtual request: ${e.message}`, 'error');
                            if (xhr.onerror) {
                                xhr.onerror();
                            }
                        }
                        return;
                    }
                    
                    // Handle normal requests
                    log(`XHR Override: Sending normal request`, 'info');
                    return originalSend.call(this, data);
                };
                
                return xhr;
            };
            
            log('XMLHttpRequest override installed successfully', 'success');
        }
        
        // Test functions
        function testFetchImage() {
            log('=== Testing fetch() for virtual image ===', 'info');
            fetch('assets/test-image.png')
                .then(response => {
                    log(`Fetch Response: status=${response.status}, ok=${response.ok}`, response.ok ? 'success' : 'error');
                    return response.blob();
                })
                .then(blob => {
                    log(`Fetch Blob: size=${blob.size}, type=${blob.type}`, 'success');
                })
                .catch(error => {
                    log(`Fetch Error: ${error.message}`, 'error');
                });
        }
        
        function testXHRImage() {
            log('=== Testing XMLHttpRequest for virtual image ===', 'info');
            const xhr = new XMLHttpRequest();
            xhr.onload = function() {
                log(`XHR Load: status=${xhr.status}, readyState=${xhr.readyState}`, xhr.status === 200 ? 'success' : 'error');
                log(`XHR Response: ${xhr.responseText ? xhr.responseText.substring(0, 50) + '...' : 'No responseText'}`, 'info');
            };
            xhr.onerror = function() {
                log(`XHR Error occurred`, 'error');
            };
            xhr.onreadystatechange = function() {
                log(`XHR State Change: readyState=${xhr.readyState}, status=${xhr.status}`, 'info');
            };
            
            xhr.open('GET', 'assets/test-image.png');
            xhr.send();
        }
        
        function testXHRText() {
            log('=== Testing XMLHttpRequest for virtual text file ===', 'info');
            const xhr = new XMLHttpRequest();
            xhr.onload = function() {
                log(`XHR Load: status=${xhr.status}, readyState=${xhr.readyState}`, xhr.status === 200 ? 'success' : 'error');
                log(`XHR Response: ${xhr.responseText}`, 'success');
            };
            xhr.onerror = function() {
                log(`XHR Error occurred`, 'error');
            };
            xhr.onreadystatechange = function() {
                log(`XHR State Change: readyState=${xhr.readyState}, status=${xhr.status}`, 'info');
            };
            
            xhr.open('GET', 'assets/test.txt');
            xhr.send();
        }
        
        // Initialize
        log('Initializing XMLHttpRequest Override Test...', 'info');
        setupXHROverride();
        log('Test ready! Click buttons to test different scenarios.', 'success');
    </script>
</body>
</html>